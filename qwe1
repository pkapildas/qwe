While the partitioned rows are in ascending order, the percent_rank () calculates the percentage of rank basis on formula:     (rank - 1) / ( rows - 1)
Eventually, all of the rows in a partition shares a range of fraction from 0 - 1
SELECT Cust_Id, Acct_Num, acct_type, Balance, PERCENT_RANK()OVER ( PARTITION BY Cust_Id  ORDER BY balance) AS Percent_rank_of_balance FROM  ACCOUNT WHERE Cust_Id  =  123004
n a normal select query , all records are interpreted serially; Sometimes there is a need to look back and forth while you are retrieving the current record in SELECT quer
SELECT Cust_Id, Acct_Num, Acct_Type , Balance ,LAG (Balance)  OVER(ORDER BY Balance)  previous_balance,LEAD(Balance)  OVER (ORDER BY Balance)  next_balanceFROM  Account WHERE Cust_Id  =  123004
In this example, the current record shows its previous record balance and its next record balance●‘previous _balance’ is Null if no records exist. Similarly, next_balance is Null if there are no further records

SELECT Cust_Id, Acct_Num, Acct_type, Balance, DENSE_RANK() OVER (PARTITIoN BY Cust_Id  ORDER BY Balance desc)ASDense_rank_of_balanceFROM  ACCOUNT WHERE Cust_Id =  123004
In this example, Dense_Rank() function assigns the same rank - (1) when the balance : 7500000 is identified same for two different accounts. But it preserved the rank - (2) without skipping it

FIRST_VALUE () function analyzes the results of analytical expression which is defined as OVER(), and then returns the first value from the ordered set of rows.Here, OVER() expression is defined with Order clause only.E.g : Select Cust_Id, Acct_Num, Acct_Type, Balance original_balance,FIRST_VALUE (Balance)  OVER( order by Balance )   Least_balanceFROM  Account where acct_type = 'FIXED DEPOSITS'

Select Cust_Id, Acct_Num, Acct_Type, Balance original_balance,FIRST_VALUE (Balance)  OVER( order by Balance )   Least_balanceFROM  Account where acct_type = 'FIXED DEPOSITS'

n this example, the original balance of the ACCOUNT table is placed in an order in OVER() expression.Later , the first_Value () has chosen the least balance out of all FIXED DEPOSITS, and displayed it across all records in total output

FIRST_VALUE () function analyzes the results of analytical expression which is defined as OVER(), and then returns the first value from the ordered set of rows.Here, OVER() expression is defined with partition by and Order by clausesE

Select Acct_Num, Acct_Type, Balance original_balance,FIRST_VALUE (Balance) OVER( partition by Acct_type order by balance)   Least_balanceFROM  Account where balance > 0 ;


select weight , FLOOR(weight) as kg, ROUND( (weight - FLOOR(weight)) *1000 ) as gms from mass_table;
#Display the name of students along with their respective scores city of residence
select s.s_name as student_name , m.score as score, d.address_city as city_of_residence from
student s
join marks m on s.s_id = m.s_id
join details d on d.school_id = m.school_id
#Display the number of students who have passed or failed respectively.
select status , count(status) as number_of_students from marks group by status;
Display the name and email address of the student who is an 'IMO finalist'.
select s.s_name as Student_Name , d.email_ID as Email_Address from student s
left join marks m on s.s_id= m.s_id
left join details d on m.school_id = d.school_id where d.accomplishments = 'IMO finalist' ;
#Display the score of those students who have scored more marks than that of a student with student_id 6.
select s.s_id, s.s_name , m.score from student as s
left join marks as m using(s_id)
where m.score >(select score from marks where s_id =6)
#Display the number of students who reside in Bangalore.
select d.address_city, count(d.address_city) as students_resides_in_Banglore from student as s
left join marks as m USING(s_id)
left join details d USING(school_id)
where d.address_city ='Banglore' group by address_city;
Display the name and score of the students who have scored marks between 80 and 90.
select s.s_name as name , m.score as score from student as s
left join marks as m on s.s_id = m.s_id where m.score between 80 and 90;
Name the course and the location, where on average, the CGPA is more than 7.5.
select distinct course , address as location from ( select course, address, AVG(CGPA)
OVER(PARTITION BY course, address) AS avg_cgpa from student2 ) as t
where avg_cgpa >7.5;
List the names of the students who have enrolled in more than one course and are from
â€˜Bangaloreâ€™.
select vname as Name , count(vname) from student2 where address='Bangalore' group by vname
having count(vname) >1 
Display the name of toppers in each course ordered by the highest CGPA first.
select vname as name, course , MAX(CGPA) as TOP_CGPA from student2
group by course order by TOP_CGPA DESC ;
List the courses under each semester where none of the students scored less than 5.
select course, semester from student2 group by semester , course having min(CGPA) >=5
 ------ 8. Display employee_id, first_name, salary, department_id for department_id 60 and 90 using Set operators. (2 Marks)
SELECT employee_id, first_name, salary,department_id
FROM employees
WHERE department_id=60
UNION
SELECT employee_id, first_name, salary,department_id
FROM employees
WHERE department_id=90
ORDER BY 3;
select * from employees;
----- 9. Display 2th highest salary of employee using subquery . (3 Mark)"
select min(salary ) 
from (select salary from employees order by salary desc limit 2)a;
----10. Write a query to fetch the employee ID, First Name, Last Name, Salary and Department ID of those employees who draw a salary more than the average salary of their respective department. (2 Mark)
	SELECT employee_id, first_name, last_name,salary,department_id FROM employees e
	WHERE salary > ANY  (SELECT avg(salary) FROM employees WHERE e.department_id  = department_id ) ORDER BY department_id ; 
----16. Write a DDL Statement to create the below table  (5 marks)

	Table name :	Course 
	Columns/Attributes	Datatype
	Course_ID             Int
	Course_Name 		  Varchar(10) 
	course_duration 	  int 
	course_title 		  varchar(20) 
	course_start_date 	  date

-- Create a check constraint on column course_duration should be less than or equal to 21.
-- Create a check constraint on course_title should be in 'Python','SQL','STATS'

-- Solution

CREATE TABLE COURSE
(
Course_ID Int,
Course_Name Varchar(10) ,
course_duration int CHECK (course_duration <= 21),
course_title varchar(20) check (course_title in ('Python','SQL','STATS')),
course_start_date date);


---- 1. Write a query that returns the result <Name of employee> joined on <Hire_date> for all the employees .
	select distinct concat(first_name,' joined on ',date_format(hire_date,'%D %M %Y')) 
		from employees;
----- 2. Write down the query to print first letter of a Name in Lower Case and all other letter in Upper Case.(3 Marks)"
	SELECT First_Name,concat(lower(SUBSTRING(First_Name,1,1)),upper(SUBSTRING(First_Name,2,LENgth(First_Name)-1)))
 		AS First_Name from employees;
----- 3. Write a query to display the first & last names of all the employees separated by a space as employee_name and the numbers of years that the employee has been working with the company for only those employees who have been working with the company for more than 30 years. (2 Mark)
	Select concat(first_name,' ',last_name) as employees_name ,year(current_date())-year(hire_date) as Tenure from employees
		where year(current_date())-year(hire_date)>30;
-----4. display the grade of the employee according to their salaries: (3 Marks)
----Solution:
	SELECT employee_id,
	CASE 
     WHEN salary<=3000 THEN 'v'
    WHEN salary>=3000 and salary<=5000 THEN 'iv'
    WHEN salary>5000 and salary<=10000 then 'iii'
    WHEN salary>10000 and salary<=50000 then 'ii'
     When salary>50000 then 'i'
END as grade
FROM employees;
----- 5. Display the First Name, Job ID and the Hire Date of all the employees who have the same joining date(3 Mark)"
select e1.first_name, e1.job_id,e1.hire_date 	from employees e1 join employees e2
		where e1.employee_id!=e2.employee_id
		and e1.hire_date=e2.hire_date;
----6. Write a Query to find maximum salary for each department.(2 Marks)
----Solution:
		Select department_id,max(salary) from Employees group by department_id;

-----7. Display the headcount of employees in each department along with department name (3 Mark)
----Solution:
	SELECT  department_name, COUNT(employee_id) headcount
	FROM  employees e INNER JOIN departments d
        ON d.department_id = e.department_id
	GROUP BY 
    e.department_id;

####
/*
1.a	Mention the differences between UNION and UNION ALL (Marks 2)
UNION ALL command is equal to UNION command,
except that UNION ALL selects all the values. 
The difference between Union and Union all is 
that Union all will not eliminate duplicate rows

1.b Can we use aggregate functions in where clause? Justify your answer. (Marks 2)
We cannot use aggregate functions in where clause because of order of evaluation of clauses. 
If you use sum () in select clause then it will be applied to the rows that specify the where condition. 
As it will not make sense to have aggregate functions in where, we can actually try using having.

/*	
1.c	Mention the difference between TRUNCATE and ROUND functions. (Marks 2)
ROUND() function rounds the number up or down depends upon the 
second argument D and the number itself(digit after D decimal places >=5 or not). 
TRUNCATE() function truncate the number up to D number of decimal places without
checking whether the digit after D decimal >=5 or not.

1.d	Mention the difference between ISNULL() and IFNULL(). (Marks 2)
IsNull() function returns TRUE (1) if the expression is a null value, otherwise FALSE (0).
IFNULL() function lets you return an alternative value if an expression is NULL.

1.e	What is referential integrity (Marks 2)
Ensures consistency of records between two related tables.
•	It establishes relationships between two different tables using referencing columns.
•	It sets up a parent child relationship between two tables. 
•	So the child table always references the parent table.  
•	At the same time, the parent table prevents entering a row in child table. 
•	Establishing a Parent - child relationship between tables is achieved by defining the tables using - FOREIGN KEY and PRIMARY KEY.

2.a	Explain about EXISTS operator (Marks 2)
The subquery is examined by each record of the main query using common key columns
•	The common key column should be same in main query and subquery
•	The subquery returns true (1) or false (0) when its conditions are satisfied with main query input column values
•	EXISTS operator is used when a record in the main query has one or more matching records in the subquery result set
•	In the next example the subquery of Transaction is executed for multiple times for each account in ACCOUNT table
SELECT A.Acct_Num, A.Balance  , A.acct_type, A.acct_status
FROM   ACCOUNT A
WHERE Exists (SELECT 'yes'
FROM Transaction T
WHERE T.Acct_Num = A.Acct_Num);

2.b	Mention the difference between WHERE and HAVING . (Marks 2)
WHERE Caluse
	WHERE Clause is used to filter the records 
    from the table based on the specified condition.
    WHERE Clause implements in row operations
    WHERE Clause cannot contain aggregate function
HAVING Clause
	HAVING Clause is used to filter record from the groups based on the 
    specified condition.
    HAVING Clause implements in column operation
    HAVING Clause can contain aggregate function
    
2.c	Count total number of 'a' appearing in the mentioned phrase ‘Great Learning’. (Marks 2)
select length('Great Learning')-length(replace('Great Learning','a','')) from Dual;

2.d After creating a table, how a unique constraint can be added to a column and 
how will you delete the same?  (Marks 2)
To add:
alter table employee_111 modify Phone_Number varchar(15) not null unique;
or
alter table employee_111 add constraint UNI_PhNo unique (Phone_Number);
To To Delete:
alter table employee_111 drop index Phone_Number;

2.e How correlated sub-query can be applied in Having clause? Explain with an example.  (Marks 2)
The SubQuery in the Having Clause can also correlates  with non grouping fields selected in the Main query. So that each result of the main query is conditionally retrieved based on the each record of subquery
SELECT Branch, P1.Product, SUM(Estimated_profit) AS Profit
FROM PROFIT_LOSS P1
GROUP BY Branch, P1.Product
HAVING SUM(Estimated_profit) > (SELECT AVG(Estimated_profit)
  FROM PROFIT_LOSS P2
  WHERE P2.Product = P1.Product)

Here, for each individual product, branch level profit is verified with overall organization level profit. The main query retrieves total- profit of each product at branch. Since the subquery is correlated with main query, the subquery is executed with an input from main query, and returns average of profit per each product. The execution of the subquery is repeated for all the corresponding inputs from main query. Having clause will conditionally filters the records of main query


Section B -30 Marks
/*
3 a. Write a Query to display average rainfall and average Evaporation for each Location 
-- except records with Evaporation as NULL. (Executable) (Marks 4)
(Use Tables: AustraliaWeather). 
-- Solutions  */

select Location, year(`Date`), month(`Date`), avg(Rainfall) , avg(Evaporation)
from australiaweather 
WHERE Evaporation IS NOT NULL
group by Location, year(`Date`), month(`Date`);
/*
3	b	Write a Query to display the maximum temperature recorded in the morning and afternoon for each 
location in each month (Use Tables: AustraliaWeather).(Marks 6)
-- Solutions  
 */
 
select Location, month(`Date`), max(Temp9am), max(Temp3pm)
 from australiaweather
group by Location, month(`Date`);

/*
3	c	Write a Query to add a new column to the existing table "australiaweather" with the name `Pressure9pm`.
 The column should be of type Int and hold a default value of 1001 in case no value is supplied during 
 insertion. Also make sure the column does not have accept null values. (Marks 5)
-- Solutions  
 */

ALTER TABLE australiaweather
ADD Pressure9pm int NOT NULL default 1001;
/*
3	d	An observation on Rainfall has to be made on a bi-yearly basis for forecasting purpose, 
hence write a query to compare Average Rainfall for month of January, 2008 and July, 2008.
--  (Use Tables: AustraliaWeather). (Marks 5)
-- Solutions 
 */

 SELECT 
    AVG(CASE WHEN DATE_FORMAT(Date, '%Y-%m') = '2008-01' THEN rainfall END) AS Jan_Avg_Rainfall,
    AVG(CASE WHEN DATE_FORMAT(Date, '%Y-%m') = '2008-07' THEN rainfall END) AS July_Avg_Rainfall
FROM 
    AustraliaWeather
WHERE 
    DATE_FORMAT(Date, '%Y-%m') IN ('2008-01', '2008-07');

/*
3	e	A study requires the total humidity recorded per day, combine the columns into a single column by 
adding the Humudity recorded in the morning and noon. 
-- Compare the average Humidity in the month of January 2009 and February 2009. (Use Tables: AustraliaWeather).(Marks 4)
-- Solutions  
 */

SELECT 
    AVG(CASE WHEN DATE_FORMAT(Date, '%Y-%m') = '2009-01' THEN (Humidity9am + Humidity3pm) END) AS Jan_Avg_Humidity,
    AVG(CASE WHEN DATE_FORMAT(Date, '%Y-%m') = '2009-02' THEN (Humidity9am + Humidity3pm) END) AS Feb_Avg_Humidity
FROM 
    AustraliaWeather
WHERE 
    DATE_FORMAT(Date, '%Y-%m') IN ('2009-01', '2009-02');

/*
3	f	The Meteorogical Department wants an analysis of the morning weather. 
Write a Query to display the highest recorded Pressure in each location in every month, 
when the evaporation record is available and temperature range in the morning should range between 14 and 30 
degrees.  Filter the records where Maximum Humidity (Executable) in the morning should not exceed 70. 
 (Make appropriate date conversions if necessary). (Use Tables: AustraliaWeather). (Marks 6)
-- Solutions  
 */
 
 
select Location, month (date_format (`Date`, '%Y-%m-%d')) as `month`, max(Pressure9am) 
from australiaweather
where Evaporation is not null and Temp9am between 14 and 30
group by Location, month (date_format (`Date`, '%Y-%m-%d'))
having max(Humidity9am) < 70;

-- Create ER> Database>Reverse Engineer>Password>next> select schema> next>next>finish
-- SECTION C – 30 MARKS
/*
Scenario:
Formula One (also Formula 1 or F1 and officially the FIA Formula One World Championship) is the highest class of single-seat auto racing that is sanctioned by the Fédération Internationale de l'Automobile (FIA). The FIA Formula One World Championship has been one of the premier forms of racing around the world since its inaugural season in 1950. 
This dataset contains data from 1950 all the way through the 2017 season, and consists of tables describing constructors, race drivers, lap times, pit stops and more.*/
/*
4.a The Racing Association is planning to conduct  the races in less worn out circuits. 
Hence, there is a need to identify the circuits where no races have been held so far. Write a Query to get the list.(Use Tables: Circuits & races )(4 marks)
-- Solutions  */
select * 
from Circuits
where circuitId Not in (select circuitId 
                        from races);
/*
4.b A journalist is writing an article about the racer who holds the record for completing a lap in shortest time duration. 
Get the details about the driver.(Use Tables : drivers & results ) (6 Marks)
-- Solutions  */
select * 
from drivers
where driverId= ( select driverID
                    from results 
                    where fastestLapTime = (select min(fastestLapTime)
                                        from results));
/*
 4.c An article is to be published for ranking the race drivers based on their points accumulated. Generate such a report along with the details of the race driver.(Use Tables : drivers ) (6 Marks)
 -- Solutions  */
select d.*, dense_rank() over(order by points desc)
from drivers d
join results r
on d.driverID=r.driverId;
/*
4.d Create a virtual table which consits of the the details of all the race drivers , along with the count of total number of races played so far. Sort the result in the order of highest races played to the lowest.(Use Tables : drivers & results) (7 Marks) [Descriptive]
-- Solutions  */
create view driver_race_details
as
select *, (select count(raceId) from results r where r.driverId=d.driverId ) as total_Races_played
from drivers d
order by total_races_played desc;
/*
4.e Generate a report for displaying the Id and names of the races conducted. Also display the driver who participated, points scored, no of laps in race and the duration taken to complete the race in milliseconds. Display the report in a sorted manner.(Use Tables : races & results) (7 Marks)
-- Solutions  */
select r.raceId,r.name,d.driverId,d.driverRef,re.points,re.laps,re.milliseconds
from results re
join races r
on re.raceId=r.raceId
join drivers d 
on re.driverId=d.driverId
order by r.raceId,re.milliseconds asc;

# Q2.Write MySQL query to find third lowest run scorer.
/* Solution */
select Player_Name , Runs  from cricket_1 order by Runs  limit 2,1;
# 6) Display the column Quantity from the table Bank_Inventory by applying the below formatting: 
-- a) convert the data type from numeric to character 
-- b) Pad the column with 0's  

/* Solution */
SELECT lpad( convert(quantity , char) , 4, "0")  from bank_inventory;

# 9)  For every branch find the sum of calculated profit after ignoring the loss.  
/* Solution */
Select branch, sum(revenue-cost)
From Bank_branch_PL
where revenue-cost > 0
Group by branch;
# Question 11:
# 11)  Find the  month wise total quantity of each product
/* Solution */
Select sum(Quantity), Month, Product
From Bank_Inventory_pricing
group by Product, Month;

# 14) Display the products and month where the total Quantity in Bank Inventory was more than 6.  
/* Solution */
Select product , month, sum(quantity )
from bank_inventory_pricing
Group by product , month
Having sum(quantity) > 6;

# Question 15:
# 15) IF Real profit is calculated as :
		Real Profit = revenue - cost  
	Find the branches for which branch level real profit is more than the estimated_profit.
/* Solution */
Select branch, sum(estimated_profit)  , sum(revenue - cost )   
From Bank_branch_PL
Group by branch
having  (sum(estimated_profit)  > sum(revenue - cost ) );


# Question 8:
# 8) Print customer_id, customer_name and other common columns  from both the Tables :  bank_customer & bank_customer_export without missing any matching customer_id key column records. 
-- Note: refer datatype conversion if found any missing records

/* Solution */
select * from bank_customer_export ;

Select  bc.customer_id ,  	bce.customer_name
from  bank_customer_export bce 
natural join   bank_customer  bc
where CAST(bce.customer_id  AS UNSIGNED) = bc.customer_id;

# Question 5:
# 5) Display the Savings Account number whose corresponding Credit cards and  AddonCredit card transactions have occured more than one time .
/* Solution */
SELECT	ba.Account_Number as savings_account_number, ba.Account_type  as savings_account_type,
	br.Account_Number as Credit_cardt_account_number, br.Account_type as	CreditCard_account_type, count(bat.transaction_date)  as Count_credit_card_trsanctions
FROM bank_Account_Details ba
LEFT JOIN bank_account_relationship_details br
ON  ba.Account_Number = br.Linking_Account_Number
LEFT JOIN bank_account_transaction bat
ON br.Account_Number = bat.Account_Number
Where br.Account_type like '%Credit%'    
group by ba.Account_Number, ba.Account_type,br.Account_Number, br.Account_type  
having count(bat.transaction_date) > 1;
#Q9. Display the employee_id, first_name, last_name, job_id and department_id of the employees who were recruited first in the department

SELECT employee_id, first_name, last_name, job_id, department_id
FROM employee_details o
WHERE hire_Date =(SELECT min(hire_Date) FROM EMPLOYEE_DETAILS i WHERE i.department_id=o.department_id);
#Q10. Display the employee_id, first_name, last_name, salary and job_id of the employees who earn maximum salary for every job.

SELECT  employee_id, first_name, last_name, salary, Job_id 
FROM employee_details o
WHERE salary = (SELECT max(salary) FROM employee_details i WHERE i.job_id=o.job_id);

CREATE SCHEMA IF NOT EXISTS Video_Games;
USE Video_Games;
SELECT * FROM Video_Games_Sales;

# Q1. Display the names of the Games, platform and total sales in North America for respective platforms.
SELECT Name,Platform, SUM(NA_Sales) Over (Partition by Platform) FROM VIdeo_Games_Sales;

# Q2. Display the name of the game, platform , Genre and total sales in North America for corresponding Genre as Genre_Sales,total sales for the given platform as Platformm_Sales and also display the global sales as total sales .
# Also arrange the results in descending order according to the Total Sales.

SELECT Name, Platform,Genre,
	SUM(NA_Sales) OVER(Partition by Genre) AS Genre_Sales,
    SUM(NA_Sales) OVER(PARTITION BY Platform) AS  Platformm_Sales,
	SUM(Global_Sales) OVER() AS  Total_Sales
    FROM VIdeo_Games_Sales
    ORDER BY Total_Sales DESC;

# Q3. Use nonaggregate window functions to produce the row number for each row 
# within its partition (Platform) ordered by release year.
SELECT
	Name, Platform, Year_of_Release, Genre,
	ROW_NUMBER() OVER(PARTITION BY Platform ORDER BY Year_of_Release DESC) AS row_num
FROM Video_Games_Sales;

# Q4. Use aggregate window functions to produce the average global sales of each row within its partition (Year of release). Also arrange the result in the descending order by year of release.
SELECT Name, Platform, Year_of_Release, 
	AVG(Global_Sales) OVER(PARTITION BY Year_of_Release) AS AvgGlobalSales_In_Millions
    FROM Video_Games_Sales
    ORDER BY Year_of_Release DESC;
   

# Q5. Display the name of the top 5 Games with highest Critic Score For Each Publisher. 

SELECT * 
from 
(SELECT Name, Platform, RANK()over(Partition by Publisher Order BY Critic_Score desc) Critic_Rank
FROM VIdeo_Games_Sales)a
Where Critic_Rank<=5;



------------------------------------------------------------------------------------
# Dataset Used: website_stats.csv and web.csv
------------------------------------------------------------------------------------
# Q6. Write a query that displays the opening date two rows forward i.e. the 1st row should display the 3rd website launch date

select * from web;
SELECT name, launch_date,
	LEAD(launch_date,2) OVER(ORDER BY launch_date) third_website_launch_date
FROM web;


# Q7. Write a query that displays the statistics for website_id = 1 i.e. for each row, show the day, the income and the income on the first day.
SELECT day, income,
	FIRST_VALUE(income) OVER(ORDER BY day) income_on_first_day
FROM website_stats
WHERE website_id = 1;


-----------------------------------------------------------------
# Dataset Used: play_store.csv 
-----------------------------------------------------------------
# Q8. For each game, show its name, genre and date of release. In the next three columns, show RANK(), DENSE_RANK() and ROW_NUMBER() sorted by the date of release.
select name, genre, released, 
	rank() over(order by released),
	dense_rank() over(order by released),
	row_number() over(order by released)
from play_store


# Datasets used: employee.csv and membership.csv

-- ---------------------------------------------------------------------------------------------------------------------------------------------------
-- Schema EmpMemb
-- -----------------------------------------------------
CREATE SCHEMA IF NOT EXISTS EmpMemb;
USE EmpMemb;


-- ---------------------------------------------------------------------------------------------------------------------------------------------------
-- Create a table Employee by refering the data file given. 

 Follow the instructions given below: 
-- -- Q9. Values in the columns Emp_id and Members_Exclusive_Offers should not be null.
-- -- Q10. Column Age should contain values greater than or equal to 18.
-- -- Q11. When inserting values in Employee table, if the value of salary column is left null, then a value 20000 should be assigned at that position. 
-- -- Q12. Assign primary key to Emp_ID
-- -- Q13. All the email ids should not be same.
-- ---------------------------------------------------------------------------------------------------------------------------------------------------

-- -----------------------------------------------------
-- Table Employee
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS Employee (
  Emp_ID VARCHAR(3) NOT NULL,
  Name VARCHAR(50) NULL,
  Age INT NULL CHECK (Age>=18),
  Email VARCHAR(100) NULL UNIQUE,
  Salary INT NULL DEFAULT 20000,
  Members_Exclusive_Offers VARCHAR(5) NOT NULL,
  PRIMARY KEY (Emp_ID)
);



-- ---------------------------------------------------------------------------------------------------------------------------------------------------
-- Create a table Membership by refering the data file given.  

 Follow the instructions given below: 
-- -- Q14. Values in the columns Prime_Membership_Active_Status and Employee_Emp_ID should not be null.
-- -- Q15. Assign a foreign key constraint on Employee_Emp_ID.
-- -- Q16. If any row from employee table is deleted, then the corresponding row from the Membership table should also get deleted.
-- ---------------------------------------------------------------------------------------------------------------------------------------------------


-- -----------------------------------------------------
-- Table Membership
-- -----------------------------------------------------
CREATE TABLE IF NOT EXISTS Membership (
  Prime_Membership_Active_Status VARCHAR(5) NOT NULL,
  Enrollment_Date VARCHAR(15) NULL,
  End_Date VARCHAR(15) NULL,
  Employee_Emp_ID VARCHAR(3) NOT NULL,
  PRIMARY KEY (Employee_Emp_ID),
  CONSTRAINT fk_Membership_Employee
    FOREIGN KEY (Employee_Emp_ID)
    REFERENCES Employee(Emp_ID)
    ON DELETE CASCADE
);


SELECT * FROM MEMBERSHIP;
SELECT * FROM EMPLOYEE;
DELETE FROM MEMBERSHIP;


DELETE FROM EMPLOYEE WHERE Emp_ID = 'G1';



###################### Use 'account_details' table for below questions

CREATE TABLE IF NOT EXISTS `account_details` (
  `acc_id` int(10) NOT NULL,
  `first_name` varchar(50) NOT NULL,
  `last_name` varchar(50) NOT NULL,
  `ssn` char(10) NOT NULL,
  `acc_holder_id` int(10) NOT NULL,
  `balance` decimal(20,4) DEFAULT '0.0000',
  PRIMARY KEY (`acc_id`));
  
INSERT INTO `account_details` (`acc_id`, `acc_holder_id`, `balance`, `first_name`, `last_name`, `ssn`) VALUES
	(1, 100, 132.1020, 'Joseph', 'Cane', '098765432'),
	(2, 300, 4435.2030, 'Kim', 'Karry', '087654321'),
	(3, 120, 2345223.6600, 'Jim', 'Anderson', '123456780'),
	(4, 90, 98763.2300, 'Jessie', 'Thomson', '765432109'),
	(5, 110, 34221.1000, 'Palak', 'Patel', '654321890'),
	(6, 80, 7634.8000, 'Max', 'Jerrard', '456789012'),
	(7, 10, 876964.7000, 'Peter', 'Koshnov', '512345670'),
	(8, 110, 299876.6000, 'Monica', 'Irodov', '120088551'),
	(9, 100, 7659809.5300, 'Petro', 'Jenkins Jr', '123456789'),
	(10, 200, 111.1200, 'Jeff', 'Joshua', '765432189' );
###################################################################################################################################################
# Q.1 Kim wants to pay Jeff 550 dollars after they both had lunch together. At the same time, GL NEWSLETTER is going to deduct 
# 150 dollars from Jeff's bank account as annual subscription. Write a query such that GL NEWSLETTER should be able to deduct the amount once Kim transfers 
# the amount to Jeff's account
# Solution: 
START TRANSACTION;
SELECT * FROM account_details WHERE first_name = 'Jeff' FOR UPDATE;
update account_details SET balance = balance - 550 where first_name = 'Kim';
update account_details SET balance = balance + 550 where first_name = 'Jeff';
select * from account_details;
COMMIT;


######################################################################################################################################
# Create table:
CREATE TABLE BANK_ACCOUNT ( Customer_id INT, 		   			  
							Account_Number VARCHAR(19),
							Account_type VARCHAR(25),
							Balance_amount INT ,
                            Account_status VARCHAR(10), 
                            Relationship_type varchar(1));
# Insert records:
INSERT INTO BANK_ACCOUNT  VALUES (123001, "4000-1956-3456",  "SAVINGS"            , 200000 ,"ACTIVE","P"); 
INSERT INTO BANK_ACCOUNT  VALUES (123001, "5000-1700-3456",  "RECURRING DEPOSITS" ,9400000 ,"ACTIVE","S");  
INSERT INTO BANK_ACCOUNT  VALUES (123002, "4000-1956-2001",  "SAVINGS"            , 400000 ,"ACTIVE","P"); 
INSERT INTO BANK_ACCOUNT  VALUES (123002, "5000-1700-5001",  "RECURRING DEPOSITS" ,7500000 ,"ACTIVE","S"); 
INSERT INTO BANK_ACCOUNT  VALUES (123003, "4000-1956-2900",  "SAVINGS"            ,750000,"INACTIVE","P"); 
INSERT INTO BANK_ACCOUNT  VALUES (123004, "5000-1700-6091",  "RECURRING DEPOSITS" ,7500000 ,"ACTIVE","S"); 
INSERT INTO BANK_ACCOUNT  VALUES (123004, "4000-1956-3401",  "SAVINGS"            , 655000 ,"ACTIVE","P"); 
INSERT INTO BANK_ACCOUNT  VALUES (123005, "4000-1956-5102",  "SAVINGS"            , 300000 ,"ACTIVE","P"); 
INSERT INTO BANK_ACCOUNT  VALUES (123006, "4000-1956-5698",  "SAVINGS"            , 455000 ,"ACTIVE" ,"P"); 
INSERT INTO BANK_ACCOUNT  VALUES (123007, "5000-1700-9800",  "SAVINGS"            , 355000 ,"ACTIVE" ,"P"); 
INSERT INTO BANK_ACCOUNT  VALUES (123007, "4000-1956-9977",  "RECURRING DEPOSITS" , 7025000,"ACTIVE" ,"S"); 
INSERT INTO BANK_ACCOUNT  VALUES (123007, "9000-1700-7777-4321",  "CREDITCARD"    ,0      ,"INACTIVE","P"); 
INSERT INTO BANK_ACCOUNT  VALUES (123008, "5000-1700-7755",  "SAVINGS"            ,NULL   ,"INACTIVE","P"); 

select * from bank_account; 

# Q.2 Write a lock query such that whenever an User X perform trasaction customer_id 123001 in table bank_account, it should only allow other users
# to read the table and not perfrom any transaction till the lock is released by User X
# Solution:

START TRANSACTION;
SELECT * FROM bank_account LOCK IN SHARE MODE;

############################################################################################################################################
# Q.3 A customer approaches a bank and wishes to open a new account. Unknonwingly two bankers try to perform same entries in the bank_account table
#Table: Bank_account
#customer_id : 123009
#Account_number : '5000-1700-9800'
#Account_type: 'SAVINGS'
#balance: 20000
#status: 'ACTIVE'
#relationship: 'P'
#How the avoid duplicate entry into the table when two users try to insert the same record at a time.
#Solution:	
	start transaction;
	Select * from Bank_account for update ;
	insert into bank_account  values ( 123009, '5000-1700-9800', 'SAVINGS', 20000, 'ACTIVE', 'P' ) ;

#############################################################################################################################################
-- ----------------------------------------------------
# Datset Used: admission_predict.csv
-- ----------------------------------------------------
# Q.4 A university is looking for candidates with GRE score between 330 and 340. Also they should be proficient in english 
#i.e. their Toefl score should not be less than 115. Create a view for this university.
#Solution:	
CREATE VIEW GT_filtered_View As
SELECT * FROM admission_predict
WHERE `GRE SCORE` BETWEEN 330 AND 340 
AND `TOEFL SCORE` >= 115;


# Q.5 Create a view of the candidates with the CGPA greater than the average CGPA.
#Solution:	
CREATE VIEW GTavg_cgpa AS
SELECT * FROM admission_predict
WHERE CGPA > 
	(SELECT AVG(CGPA) FROM admission_predict);
    
 #############################################################################################################################################
 
-- -------------------------------------------------------------------------------------
# Datsets Used: world_cup_2015.csv and world_cup_2016.csv 
-- -------------------------------------------------------------------------------------
# Q.6 Create a view "team_1516" of the players who played in world cup 2015 as well as in world cup 2016.
#Solution:	
CREATE VIEW team_1516 AS
SELECT wc15.Player_Id, wc15.Player_Name, wc15.Runs, wc15.Popularity, wc16.Charisma 
FROM WORLD_CUP_2015 AS wc15
INNER JOIN WORLD_CUP_2016 AS wc16
ON wc15.Player_id = wc16.Player_id;


# Q.7 Create a view "All_From_15" that contains all the players who played in world cup 2015 but not in the year 2016Along with those players who played in both the world cup matches.
#Solution:	
CREATE VIEW All_From_15 AS
SELECT wc15.Player_Id, wc15.Player_Name, wc15.Runs, wc15.Popularity, wc16.Charisma 
FROM WORLD_CUP_2015 AS wc15
LEFT JOIN WORLD_CUP_2016 AS wc16
ON wc15.Player_id = wc16.Player_id;


# Q.8 Create a view "All_From_16" that contains all the players who played in world cup 2016 but not in the year 2015 Along with those players who played in both the world cup matches.
#Solution:
CREATE VIEW All_From_16 AS
SELECT wc16.Player_Id, wc16.Player_Name, wc16.Runs, wc15.Popularity, wc16.Charisma 
FROM WORLD_CUP_2015 AS wc15
RIGHT JOIN
WORLD_CUP_2016 AS wc16
ON wc15.Player_id = wc16.Player_id;

# Q.9 Drop multiple views "all_from_16", "all_from_15"
#Solution:
DROP VIEW  all_from_16, all_from_15;





